<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Visualizer - Developer Toolbox</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Prettier Standalone -->
    <script src="https://unpkg.com/prettier@2.8.8/standalone.js"></script>
    <script src="https://unpkg.com/prettier@2.8.8/parser-html.js"></script>
    <script src="https://unpkg.com/prettier@2.8.8/parser-postcss.js"></script>
    <script src="https://unpkg.com/prettier@2.8.8/parser-babel.js"></script>

    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>

    <style>
        .visualizer-container {
            display: grid;
            grid-template-columns: 40fr 60fr;
            gap: 20px;
            height: calc(100vh - 160px);
            /* Adjust based on header/footer */
        }

        .editors {
            display: flex;
            flex-direction: column;
            gap: 16px;
            height: 100%;
        }

        .editor-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            /* Fix flex overflow */
        }

        .preview-pane {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .preview-header {
            padding: 12px 16px;
            background: #f3f4f6;
            color: #1f2937;
            font-weight: 600;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .run-btn {
            padding: 6px 16px;
            font-size: 0.9rem;
        }

        /* Single Mode Styles */
        .single-mode .editor-pane:not(.html-pane) {
            display: none;
        }

        .single-mode .html-pane {
            height: 100%;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 8px;


            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        textarea {
            white-space: pre;
            overflow-x: auto;
            /* display: none;  Removed to allow proper CodeMirror initialization */
        }

        .CodeMirror {
            height: 100%;
            width: 100%;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 14px;
            flex: 1;
            border-radius: 0 0 8px 8px;
            direction: ltr;
        }

        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            align-items: center;
        }

        .btn.active {
            background: #32cd32;
            color: var(--bg-dark);
            border-color: #32cd32;
        }

        /* Responsive - Better editor spacing */
        @media (max-width: 768px) {
            .visualizer-container {
                grid-template-columns: 1fr;
                height: auto;
                gap: 24px;
            }

            .editors {
                height: auto;
                gap: 16px;
            }

            .editor-pane {
                min-height: 250px;
            }

            .html-pane {
                min-height: 350px;
            }

            /* Single mode: give HTML pane even more space */
            .single-mode .html-pane {
                min-height: 50vh;
            }

            .preview-pane {
                height: 60vh;
                min-height: 400px;
            }

            .preview-pane iframe {
                min-height: 350px;
            }
        }

        @media (max-width: 480px) {
            .editor-pane {
                min-height: 200px;
            }

            .html-pane {
                min-height: 300px;
            }

            .single-mode .html-pane {
                min-height: 45vh;
            }

            .preview-pane {
                height: 50vh;
                min-height: 350px;
            }
        }
    </style>
</head>

<body>
    <script src="navbar.js"></script>

    <main class="container" style="max-width: 100%; padding-left: 20px; padding-right: 20px;">
        <div class="controls">
            <button id="mode-btn" class="btn btn-outline" onclick="toggleMode(true)">Single File Mode</button>
        </div>
        <div class="visualizer-container" id="viz-container">
            <div class="editors">
                <div class="editor-pane html-pane">
                    <div class="pane-header">
                        <span>HTML</span>
                        <button onclick="beautifyEditor('html-code', 'html')" class="btn-sm btn-outline"
                            style="margin-left: auto;">Beautify</button>
                    </div>
                    <textarea id="html-code" placeholder="<h1>Hello World</h1>"><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>

</body>
</html></textarea>
                </div>
                <div class="editor-pane">
                    <div class="pane-header">
                        CSS
                        <button onclick="beautifyEditor('css-code', 'css')" class="btn-sm btn-outline">Beautify</button>
                    </div>
                    <textarea id="css-code" placeholder="body { color: blue; }"></textarea>
                </div>
                <div class="editor-pane">
                    <div class="pane-header">
                        JavaScript
                        <button onclick="beautifyEditor('js-code', 'javascript')"
                            class="btn-sm btn-outline">Beautify</button>
                    </div>
                    <textarea id="js-code" placeholder="console.log('Hello');"></textarea>
                </div>
            </div>

            <div class="preview-pane">
                <div class="preview-header">
                    <span>Live Preview</span>
                    <button onclick="runCode()" class="btn run-btn">Run >></button>
                </div>
                <iframe id="preview-frame"></iframe>
            </div>
        </div>
    </main>

    <script>
        let isSingleMode = true;
        let htmlEditor, cssEditor, jsEditor;

        // Initialize CodeMirror editors
        document.addEventListener('DOMContentLoaded', () => {
            const commonOptions = {
                theme: 'dracula',
                lineNumbers: true,
                lineWrapping: true,
                viewportMargin: Infinity
            };

            htmlEditor = CodeMirror.fromTextArea(document.getElementById('html-code'), {
                ...commonOptions,
                mode: 'htmlmixed'
            });

            cssEditor = CodeMirror.fromTextArea(document.getElementById('css-code'), {
                ...commonOptions,
                mode: 'css'
            });

            jsEditor = CodeMirror.fromTextArea(document.getElementById('js-code'), {
                ...commonOptions,
                mode: 'javascript'
            });

            // Add change listeners to auto-run or validare if needed
            // htmlEditor.on('change', () => runCode()); 

            // Improve focus handling: Click anywhere in the pane focuses the editor
            document.querySelectorAll('.editor-pane').forEach(pane => {
                pane.addEventListener('click', (e) => {
                    // Don't refocus if clicking buttons/header
                    if (e.target.closest('.pane-header')) return;
                    
                    // Find the editor instance associated with this pane
                    let editor;
                    if (pane.classList.contains('html-pane')) editor = htmlEditor;
                    else if (pane.querySelector('#css-code')) editor = cssEditor;
                    else if (pane.querySelector('#js-code')) editor = jsEditor;
                    
                    if (editor) editor.focus();
                });
            });

            // Run initial setup
            toggleMode();
        });

        function toggleMode(shouldToggle = false) {
            const container = document.getElementById('viz-container');
            const btn = document.getElementById('mode-btn');

            if (shouldToggle) {
                isSingleMode = !isSingleMode;
            }

            if (isSingleMode) {
                container.classList.add('single-mode');
                btn.classList.add('active');
                btn.classList.remove('btn-outline');
                // Update placeholder/content if empty (Note: CodeMirror handles placeholders differently, but we'll stick to logic)
                if(htmlEditor.getValue().trim() === '') {
                     htmlEditor.setValue('<!-- Write full HTML document here -->\n<!DOCTYPE html>\n<html>\n...');
                }
            } else {
                container.classList.remove('single-mode');
                btn.classList.remove('active');
                btn.classList.add('btn-outline');
            }
            
            // Refresh editors to ensure proper rendering after display change
            setTimeout(() => {
                htmlEditor.refresh();
                cssEditor.refresh();
                jsEditor.refresh();
            }, 10);

            runCode(); 
        }

        function runCode() {
            const html = htmlEditor.getValue();
            const css = cssEditor.getValue();
            const js = jsEditor.getValue();
            const frame = document.getElementById('preview-frame');

            const doc = frame.contentDocument || frame.contentWindow.document;

            doc.open();

            if (isSingleMode) {
                // In single mode, we just inject the HTML content directly
                doc.write(html);
            } else {
                doc.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <style>${css}</style>
                    </head>
                    <body>
                        ${html}
                        <script>${js}<\/script>
                    </body>
                    </html>
                `);
            }
            doc.close();
        }

        function beautifyEditor(elementId, language) {
            let editor;
            if (language === 'html') editor = htmlEditor;
            else if (language === 'css') editor = cssEditor;
            else if (language === 'javascript') editor = jsEditor;

            if (!editor) return;

            const input = editor.getValue();

            if (!input.trim()) return;

            try {
                let parser = 'babel';
                let plugins = [prettierPlugins.babel];

                if (language === 'html') {
                    parser = 'html';
                    plugins = [prettierPlugins.html];
                } else if (language === 'css') {
                    parser = 'css';
                    plugins = [prettierPlugins.postcss];
                }

                const formatted = prettier.format(input, {
                    parser: parser,
                    plugins: plugins,
                    semi: true,
                    singleQuote: true
                });

                editor.setValue(formatted);
                runCode(); // Update preview
            } catch (error) {
                console.error('Error formatting code:', error);
                // Optional: Show error to user
            }
        }
    </script>
</body>

</html>